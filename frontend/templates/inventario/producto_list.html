{% extends "base.html" %}
{% load static %}

{% block title %}Inventario | Cantina Tita{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
            <h1 class="text-3xl font-bold text-base-content">Inventario de Productos</h1>
            <p class="text-base-content/60 mt-1">Gestiona todos los productos de la cantina</p>
        </div>
        <div class="flex gap-2">
            <!-- Botón de exportar (opcional) -->
            <button class="btn btn-outline btn-sm gap-2" title="Exportar lista">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                Exportar
            </button>
            <button class="btn btn-primary btn-sm md:btn-md gap-2 shadow-lg hover:shadow-xl transition-shadow" 
                    onclick="document.getElementById('nuevo_producto_modal').showModal()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Nuevo Producto
            </button>
        </div>
    </div>

    <!-- Estadísticas rápidas -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="stats shadow bg-base-100">
            <div class="stat">
                <div class="stat-title">Total Productos</div>
                <div class="stat-value text-primary">{{ productos.count }}</div>
            </div>
        </div>
        <div class="stats shadow bg-base-100">
            <div class="stat">
                <div class="stat-title">Bajo Stock</div>
                <div class="stat-value text-warning">
                    {% with productos|dictsort:"stock" as sorted %}
                        {% for p in sorted|slice:":1" %}
                            {% if p.stock <= 5 %}{{ sorted|length }}{% else %}0{% endif %}
                        {% endfor %}
                    {% endwith %}
                </div>
            </div>
        </div>
        <div class="stats shadow bg-base-100">
            <div class="stat">
                <div class="stat-title">Sin Stock</div>
                <div class="stat-value text-error">
                    {{ productos|length|default:0 }}
                </div>
            </div>
        </div>
        <div class="stats shadow bg-base-100">
            <div class="stat">
                <div class="stat-title">Valor Total</div>
                <div class="stat-value text-success">
                    ${{ total_value|default:"0"|floatformat:2 }}
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros y búsqueda -->
    <div class="card bg-base-100 shadow">
        <div class="card-body p-6">
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1">
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-base-content/40" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </div>
                        <input type="text" 
                               id="buscador-productos" 
                               placeholder="Buscar por nombre, código, categoría..." 
                               class="input input-bordered w-full pl-10 bg-base-100" 
                               aria-label="Buscar productos" />
                    </div>
                </div>
                <div class="flex gap-2">
                    <select class="select select-bordered" id="filtro-estado">
                        <option value="">Todos los estados</option>
                        <option value="stock_ok">Stock OK</option>
                        <option value="bajo_stock">Bajo stock</option>
                        <option value="sin_stock">Sin stock</option>
                    </select>
                    <button class="btn btn-ghost" id="btn-limpiar-filtros" title="Limpiar filtros">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de productos -->
    <div class="card bg-base-100 shadow-lg overflow-hidden">
        <div class="overflow-x-auto">
            <table class="table table-zebra w-full" id="tabla-inventario">
                <thead>
                    <tr class="bg-base-200">
                        <th class="text-sm font-semibold uppercase">Código</th>
                        <th class="text-sm font-semibold uppercase">Producto</th>
                        <th class="text-sm font-semibold uppercase">Categoría</th>
                        <th class="text-sm font-semibold uppercase text-right">Precio</th>
                        <th class="text-sm font-semibold uppercase text-center">Stock</th>
                        <th class="text-sm font-semibold uppercase">Estado</th>
                        <th class="text-sm font-semibold uppercase text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody id="cuerpo-tabla">
                    {% for producto in productos %}
                    <tr class="hover" data-stock="{{ producto.stock }}" data-codigo="{{ producto.codigo|lower }}" data-nombre="{{ producto.nombre|lower }}">
                        <td>
                            <div class="font-mono text-sm badge badge-outline p-3">{{ producto.codigo }}</div>
                        </td>
                        <td>
                            <div class="font-semibold">{{ producto.nombre }}</div>
                            {% if producto.descripcion %}
                            <div class="text-xs text-base-content/60">{{ producto.descripcion|truncatechars:50 }}</div>
                            {% endif %}
                        </td>
                        <td>
                            {% if producto.categoria %}
                            <span class="badge badge-ghost">{{ producto.categoria.nombre }}</span>
                            {% else %}
                            <span class="text-base-content/40 text-xs">Sin categoría</span>
                            {% endif %}
                        </td>
                        <td class="text-right font-bold">${{ producto.precio_venta|floatformat:2 }}</td>
                        <td class="text-center">
                            <div class="inline-flex items-center gap-2">
                                <span class="font-bold text-lg {% if producto.stock == 0 %}text-error{% elif producto.stock <= 5 %}text-warning{% else %}text-success{% endif %}">
                                    {{ producto.stock }}
                                </span>
                                {% if producto.unidad_medida %}
                                <span class="text-xs text-base-content/60">{{ producto.unidad_medida }}</span>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            {% if producto.stock == 0 %}
                            <div class="badge badge-error gap-2">
                                <span class="h-2 w-2 rounded-full bg-current"></span>
                                Sin Stock
                            </div>
                            {% elif producto.stock <= 5 %}
                            <div class="badge badge-warning gap-2">
                                <span class="h-2 w-2 rounded-full bg-current"></span>
                                Bajo Stock
                            </div>
                            {% else %}
                            <div class="badge badge-success gap-2">
                                <span class="h-2 w-2 rounded-full bg-current"></span>
                                En Stock
                            </div>
                            {% endif %}
                        </td>
                        <td>
                            <div class="flex justify-center gap-1">
                                <a href="{% url 'inventario:producto_update' producto.id %}" 
                                   class="btn btn-ghost btn-xs btn-square text-info hover:text-info-content hover:bg-info"
                                   title="Editar producto">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                </a>
                                <a href="{% url 'inventario:producto_detail' producto.id %}" 
                                   class="btn btn-ghost btn-xs btn-square text-primary hover:text-primary-content hover:bg-primary"
                                   title="Ver detalles">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                    </svg>
                                </a>
                                <button class="btn btn-ghost btn-xs btn-square text-error hover:text-error-content hover:bg-error"
                                        onclick="confirmarEliminacion('{{ producto.id }}', '{{ producto.nombre|escapejs }}')"
                                        title="Eliminar producto">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr id="fila-vacia">
                        <td colspan="7" class="text-center py-12">
                            <div class="flex flex-col items-center gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-base-content/20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                                </svg>
                                <h3 class="text-lg font-semibold text-base-content/60">No hay productos registrados</h3>
                                <p class="text-base-content/40">Comienza agregando tu primer producto</p>
                                <button class="btn btn-primary btn-sm mt-2" onclick="document.getElementById('nuevo_producto_modal').showModal()">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                    </svg>
                                    Agregar primer producto
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Paginación -->
        {% if productos.has_other_pages %}
        <div class="card-body border-t border-base-300">
            <div class="flex justify-between items-center">
                <div class="text-sm text-base-content/60">
                    Mostrando {{ productos.start_index }}–{{ productos.end_index }} de {{ productos.paginator.count }} productos
                </div>
                <div class="join">
                    {% if productos.has_previous %}
                    <a href="?page={{ productos.previous_page_number }}" class="join-item btn btn-sm">«</a>
                    {% endif %}
                    
                    {% for num in productos.paginator.page_range %}
                        {% if productos.number == num %}
                        <a href="?page={{ num }}" class="join-item btn btn-sm btn-active">{{ num }}</a>
                        {% elif num > productos.number|add:'-3' and num < productos.number|add:'3' %}
                        <a href="?page={{ num }}" class="join-item btn btn-sm">{{ num }}</a>
                        {% endif %}
                    {% endfor %}
                    
                    {% if productos.has_next %}
                    <a href="?page={{ productos.next_page_number }}" class="join-item btn btn-sm">»</a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal para nuevo producto -->
<dialog id="nuevo_producto_modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box max-w-2xl p-0 overflow-hidden">
        <div class="bg-primary text-primary-content p-6">
            <h3 class="font-bold text-2xl">Nuevo Producto</h3>
            <p class="opacity-90">Agrega un nuevo producto al inventario</p>
        </div>
        
        <form method="POST" action="{% url 'inventario:producto_create' %}" class="p-6" id="form-producto">
            {% csrf_token %}
            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Nombre *</span>
                        </label>
                        <input type="text" 
                               name="nombre" 
                               class="input input-bordered w-full" 
                               placeholder="Ej: Coca-Cola 500ml" 
                               required 
                               autofocus />
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Código *</span>
                        </label>
                        <input type="text" 
                               name="codigo" 
                               class="input input-bordered w-full" 
                               placeholder="Ej: CC-500" 
                               required />
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Precio *</span>
                        </label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-base-content/60">$</span>
                            <input type="number" 
                                   name="precio_venta" 
                                   step="0.01" 
                                   min="0" 
                                   class="input input-bordered w-full pl-8" 
                                   placeholder="0.00" 
                                   required />
                        </div>
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Stock inicial</span>
                        </label>
                        <input type="number" 
                               name="stock" 
                               value="0" 
                               min="0" 
                               class="input input-bordered w-full" />
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Unidad de medida</span>
                        </label>
                        <select name="unidad_medida" class="select select-bordered w-full">
                            <option value="">Seleccionar</option>
                            <option value="unidad">Unidad</option>
                            <option value="litro">Litro</option>
                            <option value="kilo">Kilo</option>
                            <option value="paquete">Paquete</option>
                            <option value="caja">Caja</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold">Descripción</span>
                    </label>
                    <textarea name="descripcion" 
                              class="textarea textarea-bordered h-24" 
                              placeholder="Descripción opcional del producto..."></textarea>
                </div>
                
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold">Categoría</span>
                    </label>
                    <select name="categoria" class="select select-bordered w-full">
                        <option value="">Sin categoría</option>
                        {% for categoria in categorias %}
                        <option value="{{ categoria.id }}">{{ categoria.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="modal-action mt-8">
                <button type="button" 
                        class="btn btn-ghost" 
                        onclick="document.getElementById('nuevo_producto_modal').close()">
                    Cancelar
                </button>
                <button type="submit" class="btn btn-primary gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    Guardar Producto
                </button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop"><button>cerrar</button></form>
</dialog>

<!-- Modal de confirmación para eliminar -->
<dialog id="eliminar_producto_modal" class="modal">
    <div class="modal-box max-w-md">
        <h3 class="font-bold text-lg text-error flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.502 0L4.198 16.5c-.77.833.192 2.5 1.732 2.5z" />
            </svg>
            Confirmar Eliminación
        </h3>
        <p class="py-4">
            ¿Estás seguro de eliminar el producto 
            <span id="nombre-producto-eliminar" class="font-bold text-error"></span>?
        </p>
        <p class="text-sm text-base-content/60 mb-4">
            Esta acción no se puede deshacer. Se eliminarán todos los datos relacionados.
        </p>
        <div class="modal-action">
            <form method="POST" id="form-eliminar" action="">
                {% csrf_token %}
                <input type="hidden" name="method" value="DELETE">
                <button type="button" 
                        class="btn btn-ghost" 
                        onclick="document.getElementById('eliminar_producto_modal').close()">
                    Cancelar
                </button>
                <button type="submit" class="btn btn-error gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    Sí, eliminar
                </button>
            </form>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop"><button>cerrar</button></form>
</dialog>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Variables globales
    const buscador = document.getElementById('buscador-productos');
    const filtroEstado = document.getElementById('filtro-estado');
    const btnLimpiar = document.getElementById('btn-limpiar-filtros');
    const filas = document.querySelectorAll('#cuerpo-tabla tr[data-nombre]');
    const filaVacia = document.getElementById('fila-vacia');
    
    // Función para filtrar la tabla
    function filtrarTabla() {
        const termino = buscador ? buscador.value.toLowerCase() : '';
        const estado = filtroEstado ? filtroEstado.value : '';
        let visibleCount = 0;
        
        filas.forEach(fila => {
            const nombre = fila.dataset.nombre || '';
            const codigo = fila.dataset.codigo || '';
            const stock = parseInt(fila.dataset.stock) || 0;
            
            // Verificar búsqueda
            const coincideBusqueda = nombre.includes(termino) || codigo.includes(termino);
            
            // Verificar filtro de estado
            let coincideEstado = true;
            if (estado === 'sin_stock' && stock > 0) coincideEstado = false;
            if (estado === 'bajo_stock' && (stock > 5 || stock === 0)) coincideEstado = false;
            if (estado === 'stock_ok' && stock <= 5) coincideEstado = false;
            
            // Mostrar/ocultar fila
            if (coincideBusqueda && coincideEstado) {
                fila.style.display = '';
                visibleCount++;
            } else {
                fila.style.display = 'none';
            }
        });
        
        // Mostrar mensaje si no hay resultados
        if (filaVacia) {
            if (visibleCount === 0 && (termino || estado)) {
                filaVacia.style.display = '';
                filaVacia.innerHTML = `
                    <td colspan="7" class="text-center py-12">
                        <div class="flex flex-col items-center gap-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-base-content/30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <h3 class="font-semibold">No se encontraron productos</h3>
                            <p class="text-sm text-base-content/60">Intenta con otros términos de búsqueda</p>
                        </div>
                    </td>
                `;
            } else if (visibleCount === 0) {
                filaVacia.style.display = '';
            } else {
                filaVacia.style.display = 'none';
            }
        }
    }
    
    // Event Listeners
    if (buscador) {
        buscador.addEventListener('input', filtrarTabla);
    }
    
    if (filtroEstado) {
        filtroEstado.addEventListener('change', filtrarTabla);
    }
    
    if (btnLimpiar) {
        btnLimpiar.addEventListener('click', function() {
            if (buscador) buscador.value = '';
            if (filtroEstado) filtroEstado.value = '';
            filtrarTabla();
        });
    }
    
    // Auto-close alerts
    const alerts = document.querySelectorAll('.alert');
    alerts.forEach(alert => {
        setTimeout(() => {
            alert.style.opacity = '0';
            alert.style.transform = 'translateY(-10px)';
            setTimeout(() => alert.remove(), 300);
        }, 4000);
    });
    
    // Función para confirmar eliminación
    window.confirmarEliminacion = function(id, nombre) {
        const nombreSpan = document.getElementById('nombre-producto-eliminar');
        const form = document.getElementById('form-eliminar');
        
        if (nombreSpan) nombreSpan.textContent = nombre;
        if (form) {
            // Generar URL dinámica para eliminación
            const urlBase = "{% url 'inventario:producto_delete' 0 %}".replace('0', id);
            form.action = urlBase;
            
            // Mostrar modal
            document.getElementById('eliminar_producto_modal').showModal();
        }
    }
    
    // Auto-focus en búsqueda
    if (buscador && !document.querySelector('.alert')) {
        setTimeout(() => buscador.focus(), 100);
    }
    
    // Tecla Escape para cerrar modales
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const modales = document.querySelectorAll('dialog[open]');
            modales.forEach(modal => modal.close());
        }
    });
});
</script>
{% endblock %}